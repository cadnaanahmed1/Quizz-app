<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radio Button Quiz</title>
  <style>
    /* CSS waa sida aad hore u qortay, ma beddelin */
  </style>
</head>
<body>
  <div class="container">
    <h1>Radio Button Quiz</h1>

    <input type="text" id="username" placeholder="Enter your name" required />
    <button id="startBtn">Start Quiz</button>

    <div id="quizContainer" style="display: none;">
      <div id="question" class="question"></div>
      <form id="optionsForm"></form>
    </div>

    <button id="submitBtn" disabled>Submit</button>
    <button id="nextBtn" disabled>Next Question</button>
    <button id="viewScoreBtn">View Score</button>

    <div id="bckkk">
      <a href="index.html" id="backr">Back to Home</a>
    </div>

    <div id="result"></div>
    <button id="backBtn">Back to Home</button>
  </div>

<script>
  const API_URL = "https://quizz-app-2-b130.onrender.com/api/quizzes";
  const SCORES_URL = "https://quizz-app-2-b130.onrender.com/api/results";

  const questionEl = document.getElementById("question");
  const optionsForm = document.getElementById("optionsForm");
  const submitBtn = document.getElementById("submitBtn");
  const nextBtn = document.getElementById("nextBtn");
  const resultEl = document.getElementById("result");
  const backBtn = document.getElementById("backBtn");
  const viewScoreBtn = document.getElementById("viewScoreBtn");
  const usernameInput = document.getElementById("username");
  const quizContainer = document.getElementById("quizContainer");
  const startBtn = document.getElementById("startBtn");

  let quizzes = [];
  let currentIndex = 0;
  let score = 0;
  let answered = false;

  async function fetchQuizzes() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error("Failed to fetch quizzes");
      quizzes = await res.json();

      if (quizzes.length === 0) {
        quizContainer.innerHTML = "<p>No quiz questions available. Please add some first.</p>";
        submitBtn.style.display = "none";
        nextBtn.style.display = "none";
        return;
      }

      loadQuestion();
    } catch (error) {
      quizContainer.innerHTML = "<p>Error loading quizzes. Please try again later.</p>";
      console.error(error);
      submitBtn.style.display = "none";
      nextBtn.style.display = "none";
    }
  }

  startBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name) {
      alert("Fadlan geli magacaaga si aad u bilowdo quiz-ka.");
      return;
    }

    startBtn.style.display = "none";
    usernameInput.disabled = true;
    quizContainer.style.display = "block";
    submitBtn.style.display = "inline-block";
    nextBtn.style.display = "inline-block";

    fetchQuizzes();
  });

  function loadQuestion() {
    answered = false;
    submitBtn.disabled = true;
    nextBtn.disabled = true;
    resultEl.textContent = "";
    viewScoreBtn.style.display = "none";

    const quiz = quizzes[currentIndex];
    questionEl.textContent = `Q${currentIndex + 1}: ${quiz.question}`;

    optionsForm.innerHTML = "";
    quiz.options.forEach((option, idx) => {
      const optionId = `option${idx}`;
      const label = document.createElement("label");
      label.classList.add("option");
      label.htmlFor = optionId;
      label.innerHTML = `
        <input type="radio" id="${optionId}" name="option" value="${idx}">
        ${option}
      `;
      optionsForm.appendChild(label);
    });

    // Remove previous listener first to avoid stacking listeners
    optionsForm.onchange = null;
    optionsForm.onchange = () => {
      const selected = optionsForm.querySelector('input[type="radio"]:checked');
      submitBtn.disabled = !selected || answered;
    };

    if (currentIndex === quizzes.length - 1) {
      nextBtn.style.display = "none";
    } else {
      nextBtn.style.display = "inline-block";
      nextBtn.textContent = "Next Question";
    }
  }

  submitBtn.addEventListener("click", (e) => {
    e.preventDefault();
    if (answered) return;

    const selectedOption = optionsForm.querySelector('input[type="radio"]:checked');
    if (!selectedOption) {
      alert("Please select an answer before submitting.");
      return;
    }

    answered = true;
    submitBtn.disabled = true;
    nextBtn.disabled = false;

    const selectedIndex = Number(selectedOption.value);
    const quiz = quizzes[currentIndex];

    const labels = optionsForm.querySelectorAll("label.option");
    labels.forEach((label, idx) => {
      const isCorrect = idx === quiz.correctAnswer;
      const isSelected = idx === selectedIndex;

      if (isCorrect) label.classList.add("correct");
      if (isSelected && !isCorrect) label.classList.add("wrong");
      label.querySelector("input").disabled = true;
    });

    if (selectedIndex === quiz.correctAnswer) {
      score++;
    }

    if (currentIndex === quizzes.length - 1) {
      setTimeout(() => {
        showFinalResult();
      }, 1000);
    }
  });

  nextBtn.addEventListener("click", () => {
    currentIndex++;
    if (currentIndex < quizzes.length) {
      loadQuestion();
    } else {
      showFinalResult();
    }
  });

  viewScoreBtn.addEventListener("click", () => {
    const username = usernameInput.value.trim();
    resultEl.textContent = `${username}, Quiz Complete! Your final score: ${score} / ${quizzes.length}`;
    viewScoreBtn.style.display = "none";
  });

  backBtn.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  function saveResultToServer() {
    const username = usernameInput.value.trim();
    const total = quizzes.length;

    fetch(SCORES_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        username,
        score,
        total,
      }),
    })
    .then((res) => res.json())
    .then((data) => {
      console.log("Result saved:", data);
    })
    .catch((err) => {
      console.error("Error saving result:", err);
    });
  }

  function showFinalResult() {
    questionEl.style.display = "none";
    optionsForm.style.display = "none";
    submitBtn.style.display = "none";
    nextBtn.style.display = "none";
    viewScoreBtn.style.display = "inline-block";

    const username = usernameInput.value.trim();
    resultEl.textContent = `${username}, Quiz Complete! Your final score: ${score} / ${quizzes.length}`;

    saveResultToServer();
  }
</script>
</body>
</html>
